# üó∫Ô∏è ROADMAP COMPL√àTE - Auto Parts PWA

## üì¶ Phase 1 : Backend - Configuration de base (JOUR 1-2)

### 1.1 Installer les d√©pendances
```bash
npm install @fastify/jwt @fastify/rate-limit @fastify/auth bcryptjs
npm install @aws-sdk/client-s3 @aws-sdk/s3-request-presigner sharp
npm install jsonwebtoken
```

### 1.2 Mettre √† jour `.env`
```env
# JWT
JWT_SECRET=votre_secret_super_securise_minimum_32_caracteres
JWT_EXPIRE=7d

# Cloudflare R2
R2_ENDPOINT=https://ACCOUNT_ID.r2.cloudflarestorage.com
R2_ACCESS_KEY_ID=votre_access_key
R2_SECRET_ACCESS_KEY=votre_secret_key
R2_BUCKET_NAME=auto-parts-images
R2_PUBLIC_URL=https://images.votre-domaine.com

# Beam Cloud (apr√®s cr√©ation compte)
BEAM_API_KEY=votre_beam_api_key
BEAM_DEPLOYMENT_URL=https://votre-app.beam.cloud
```

### 1.3 Cr√©er la structure des dossiers
```
Backend-server/
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îú‚îÄ‚îÄ database.js
‚îÇ   ‚îî‚îÄ‚îÄ cloudflareR2.js          ‚Üê NOUVEAU
‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îú‚îÄ‚îÄ auth.js                  ‚Üê NOUVEAU
‚îÇ   ‚îî‚îÄ‚îÄ rateLimiter.js           ‚Üê NOUVEAU
‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îú‚îÄ‚îÄ authRoutes.js            ‚Üê NOUVEAU
‚îÇ   ‚îî‚îÄ‚îÄ ... (autres routes)
```

### 1.4 Tester localement
```bash
npm run dev
```

---

## ‚òÅÔ∏è Phase 2 : Cloudflare R2 Setup (JOUR 2-3)

### 2.1 Cr√©er un compte Cloudflare R2
1. Aller sur https://dash.cloudflare.com/
2. S√©lectionner "R2" dans le menu
3. Cr√©er un bucket : `auto-parts-images`
4. Cr√©er les dossiers :
   - `/thumbs/products/`
   - `/images/products/`

### 2.2 Obtenir les credentials
1. R2 ‚Üí Manage R2 API Tokens
2. Cr√©er un token avec permissions Read & Write
3. Copier `Access Key ID` et `Secret Access Key`
4. Noter l'endpoint (ex: `https://abc123.r2.cloudflarestorage.com`)

### 2.3 Configurer le domaine personnalis√©
1. R2 ‚Üí Settings ‚Üí Custom Domains
2. Ajouter `images.votre-domaine.com`
3. V√©rifier DNS (CNAME vers R2)

### 2.4 Tester l'upload
```bash
# Cr√©er un fichier de test
node
> const { uploadImage } = require('./config/cloudflareR2');
> const fs = require('fs');
> const buffer = fs.readFileSync('test-image.jpg');
> uploadImage(buffer, 'test.jpg', 'products').then(console.log);
```

---

## üîê Phase 3 : Authentification JWT (JOUR 3-4)

### 3.1 Ajouter le champ password au mod√®le User
```javascript
// models/User.js - Ajouter :
password: {
  type: String,
  required: true,
  select: false // Ne pas renvoyer par d√©faut
}
```

### 3.2 Cr√©er les routes d'auth
- POST `/api/auth/register` - Cr√©er compte
- POST `/api/auth/login` - Se connecter
- GET `/api/auth/me` - Profil (prot√©g√©)
- POST `/api/auth/refresh` - Rafra√Æchir token

### 3.3 Prot√©ger les routes sensibles
```javascript
// Exemple dans commandeRoutes.js
fastify.post('/', {
  preHandler: fastify.auth([fastify.authenticate])
}, async (request, reply) => {
  // Route prot√©g√©e - userId disponible dans request.user
});
```

### 3.4 Tester avec curl
```bash
# Register
curl -X POST http://localhost:5000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"name":"Test","email":"test@test.com","password":"password123"}'

# Login
curl -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@test.com","password":"password123"}'

# Utiliser le token
TOKEN="<token_re√ßu>"
curl http://localhost:5000/api/auth/me \
  -H "Authorization: Bearer $TOKEN"
```

---

## üåê Phase 4 : D√©ploiement Beam Cloud (JOUR 4-5)

### 4.1 Cr√©er un compte Beam
1. Aller sur https://www.beam.cloud/
2. S'inscrire
3. Installer Beam CLI :
```bash
npm install -g @beam-cloud/cli
beam login
```

### 4.2 Cr√©er `beam.yaml`
```yaml
name: auto-parts-api
runtime: node18

build:
  commands:
    - npm install

start:
  command: node server.js

env:
  - MONGODB_URI
  - JWT_SECRET
  - R2_ENDPOINT
  - R2_ACCESS_KEY_ID
  - R2_SECRET_ACCESS_KEY
  - R2_BUCKET_NAME
  - R2_PUBLIC_URL

resources:
  memory: 1024
  cpu: 1

scaling:
  min: 1
  max: 5

health:
  path: /
  interval: 30s
```

### 4.3 D√©ployer
```bash
# Premier d√©ploiement
beam deploy

# Voir les logs
beam logs

# Mettre √† jour les variables d'environnement
beam env set MONGODB_URI "mongodb+srv://..."
beam env set JWT_SECRET "votre_secret"
```

### 4.4 Obtenir l'URL de production
```bash
beam info
# Copier l'URL : https://votre-app.beam.cloud
```

---

## üåç Phase 5 : Configuration Nginx (JOUR 5-6)

### 5.1 Installer Nginx
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install nginx

# macOS
brew install nginx
```

### 5.2 Configuration `/etc/nginx/sites-available/autoparts`
```nginx
# Force HTTPS
server {
    listen 80;
    server_name votre-domaine.com www.votre-domaine.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name votre-domaine.com www.votre-domaine.com;

    # SSL certificates (Let's Encrypt)
    ssl_certificate /etc/letsencrypt/live/votre-domaine.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/votre-domaine.com/privkey.pem;
    
    # Security headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/javascript application/json application/javascript;

    # API Proxy ‚Üí Beam Cloud
    location /api/ {
        proxy_pass https://votre-app.beam.cloud;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # Static files avec versioning
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
        root /var/www/autoparts/public;
        expires 1y;
        add_header Cache-Control "public, immutable";
        
        # Support versioned files (app.v123.js)
        try_files $uri $uri/ =404;
    }

    # PWA files
    location = /manifest.json {
        root /var/www/autoparts/public;
        expires 1h;
        add_header Cache-Control "public";
    }

    location = /service-worker.js {
        root /var/www/autoparts/public;
        expires 0;
        add_header Cache-Control "no-cache";
    }

    # Frontend (React/Vue/Svelte)
    location / {
        root /var/www/autoparts/public;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
}

# Images CDN (Cloudflare R2)
server {
    listen 443 ssl http2;
    server_name images.votre-domaine.com;

    ssl_certificate /etc/letsencrypt/live/votre-domaine.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/votre-domaine.com/privkey.pem;

    location / {
        proxy_pass https://ACCOUNT_ID.r2.cloudflarestorage.com/auto-parts-images/;
        proxy_set_header Host ACCOUNT_ID.r2.cloudflarestorage.com;
        
        # Cache images
        proxy_cache_valid 200 365d;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

### 5.3 Activer et tester
```bash
sudo ln -s /etc/nginx/sites-available/autoparts /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### 5.4 Installer SSL (Let's Encrypt)
```bash
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d votre-domaine.com -d www.votre-domaine.com -d images.votre-domaine.com
```

---

## üì± Phase 6 : Frontend PWA avec TanStack Query (JOUR 6-8)

### 6.1 Installer les d√©pendances
```bash
npm create vite@latest frontend-pwa -- --template react
cd frontend-pwa
npm install @tanstack/react-query axios workbox-webpack-plugin
```

### 6.2 Configuration TanStack Query
```javascript
// src/lib/queryClient.js
import { QueryClient } from '@tanstack/react-query';

export const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 5 * 60 * 1000, // 5 minutes
      cacheTime: 10 * 60 * 1000, // 10 minutes
      retry: 3,
      retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 30000),
      networkMode: 'offlineFirst', // Support r√©seaux instables
      refetchOnWindowFocus: true,
      refetchOnReconnect: true,
    },
  },
});
```

### 6.3 Service Worker avec Workbox
```javascript
// public/service-worker.js
import { precacheAndRoute } from 'workbox-precaching';
import { registerRoute } from 'workbox-routing';
import { CacheFirst, NetworkFirst, StaleWhileRevalidate } from 'workbox-strategies';
import { ExpirationPlugin } from 'workbox-expiration';
import { CacheableResponsePlugin } from 'workbox-cacheable-response';

// Precache des assets statiques
precacheAndRoute(self.__WB_MANIFEST);

// Images R2 - Cache First
registerRoute(
  ({ url }) => url.hostname === 'images.votre-domaine.com',
  new CacheFirst({
    cacheName: 'images-cache',
    plugins: [
      new ExpirationPlugin({
        maxEntries: 200,
        maxAgeSeconds: 30 * 24 * 60 * 60, // 30 jours
      }),
      new CacheableResponsePlugin({
        statuses: [0, 200],
      }),
    ],
  })
);

// API - Network First avec fallback
registerRoute(
  ({ url }) => url.pathname.startsWith('/api/'),
  new NetworkFirst({
    cacheName: 'api-cache',
    plugins: [
      new ExpirationPlugin({
        maxEntries: 50,
        maxAgeSeconds: 5 * 60, // 5 minutes
      }),
    ],
  })
);

// Produits - Stale While Revalidate
registerRoute(
  ({ url }) => url.pathname.startsWith('/api/pieces'),
  new StaleWhileRevalidate({
    cacheName: 'products-cache',
    plugins: [
      new ExpirationPlugin({
        maxEntries: 100,
        maxAgeSeconds: 24 * 60 * 60, // 24h
      }),
    ],
  })
);
```

---

## üéØ Phase 7 : Features Marketplace (JOUR 8-10)

### 7.1 Routes marketplace √† ajouter
```javascript
// routes/marketplaceRoutes.js
- GET /api/marketplace/products (liste publique)
- GET /api/marketplace/products/:id (d√©tail)
- POST /api/marketplace/cart (ajouter au panier)
- POST /api/marketplace/checkout (valider commande)
- GET /api/marketplace/orders (mes commandes - prot√©g√©)
```

### 7.2 Filtres avanc√©s
```javascript
// Filtres par prix range et couleur
GET /api/pieces?minPrice=50&maxPrice=200&couleur=rouge&etat=neuf
```

---

## ‚úÖ Checklist finale

### Backend
- [ ] MongoDB Atlas configur√© et accessible
- [ ] Cloudflare R2 configur√© avec uploads fonctionnels
- [ ] JWT auth impl√©ment√© et test√©
- [ ] Rate limiting actif
- [ ] Toutes les routes test√©es (Postman/Insomnia)
- [ ] D√©ploy√© sur Beam Cloud
- [ ] Variables d'environnement configur√©es

### Infrastructure
- [ ] Nginx configur√© avec HTTPS
- [ ] SSL Let's Encrypt actif
- [ ] Proxy API fonctionnel
- [ ] CDN images R2 accessible
- [ ] Compression gzip active

### Frontend PWA
- [ ] Service Worker enregistr√©
- [ ] TanStack Query configur√©
- [ ] Cache Workbox fonctionnel
- [ ] Mode offline op√©rationnel
- [ ] Manifest.json valide
- [ ] Installation PWA test√©e

### S√©curit√©
- [ ] HTTPS uniquement (pas de HTTP)
- [ ] Rate limiting actif
- [ ] JWT expiration configur√©e
- [ ] Headers de s√©curit√© Nginx
- [ ] Pas de credentials dans le code
- [ ] Variables d'environnement s√©curis√©es

---

## üìä Prochaines √©tapes sugg√©r√©es

1. **Analytics** : Ajouter Plausible/Umami pour tracking
2. **Monitoring** : Sentry pour error tracking
3. **CI/CD** : GitHub Actions pour d√©ploiement auto
4. **Tests** : Jest + Supertest pour l'API
5. **Documentation** : Swagger/OpenAPI pour l'API