# Backend Deployment Guide - Auto Parts API

## üöÄ Best Hosting Options (Free & Paid)

### **Option 1: Render.com (Recommended - FREE)**
‚úÖ Free tier available  
‚úÖ Easy deployment  
‚úÖ Auto-deploy from GitHub  
‚úÖ Built-in SSL  
‚úÖ Good for Node.js + MongoDB  

### **Option 2: Railway.app**
‚úÖ $5/month free credit  
‚úÖ Very fast deployment  
‚úÖ Modern dashboard  

### **Option 3: Heroku**
‚ö†Ô∏è No longer free  
üí∞ $7/month minimum  

### **Option 4: Vercel (For API Routes)**
‚úÖ Free tier  
‚ö†Ô∏è Better for serverless, not full Express apps  

### **Option 5: DigitalOcean App Platform**
üí∞ $5/month minimum  
‚úÖ Professional grade  

---

## üìã Step-by-Step: Deploy to Render.com (FREE)

### **Step 1: Prepare Your Backend**

#### 1.1 Update `server.js` for production
```javascript
// server.js - Add this at the top
require('dotenv').config();
const express = require('express');
const cors = require('cors');
const helmet = require('helmet');
const compression = require('compression');
const morgan = require('morgan');
const path = require('path');
const connectDB = require('./config/database');

const app = express();

// Connect to database
connectDB();

// Security & CORS
app.use(helmet({
  crossOriginResourcePolicy: { policy: "cross-origin" }
}));

// IMPORTANT: Update CORS for production
app.use(cors({
  origin: [
    'http://localhost:3000',
    'http://localhost:5173',
    'https://your-frontend-domain.vercel.app', // Add your frontend URL
    'https://your-pwa-app.netlify.app'
  ],
  credentials: true
}));

app.use(express.json());
app.use(express.urlencoded({ extended: true }));
app.use(compression());

if (process.env.NODE_ENV !== 'production') {
  app.use(morgan('dev'));
}

// Serve static images
app.use('/images', express.static(path.join(__dirname, 'public/images')));

// Health check route
app.get('/health', (req, res) => {
  res.json({ status: 'OK', timestamp: new Date() });
});

// API Routes
app.use('/api/users', require('./routes/userRoutes'));
app.use('/api/pieces', require('./routes/pieceRoutes'));
app.use('/api/categories', require('./routes/categorieRoutes'));
app.use('/api/vehicules', require('./routes/vehiculeRoutes'));
app.use('/api/commandes', require('./routes/commandeRoutes'));
app.use('/api/factures', require('./routes/factureRoutes'));
app.use('/api/messages', require('./routes/messageRoutes'));

// 404 handler
app.use((req, res) => {
  res.status(404).json({ success: false, message: 'Route non trouv√©e' });
});

// Error handler
app.use((err, req, res, next) => {
  console.error(err.stack);
  res.status(err.status || 500).json({
    success: false,
    message: err.message || 'Erreur serveur',
    error: process.env.NODE_ENV === 'development' ? err : {}
  });
});

// IMPORTANT: Use PORT from environment
const PORT = process.env.PORT || 5000;
app.listen(PORT, '0.0.0.0', () => {
  console.log(`üöÄ Serveur d√©marr√© sur le port ${PORT}`);
  console.log(`üåç Mode: ${process.env.NODE_ENV}`);
});
```

#### 1.2 Create `package.json` scripts
```json
{
  "name": "auto-parts-backend",
  "version": "1.0.0",
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js"
  },
  "engines": {
    "node": "18.x"
  }
}
```

#### 1.3 Create `.gitignore`
```
node_modules/
.env
.DS_Store
*.log
```

---

### **Step 2: Push to GitHub**

```bash
# Initialize git (if not done)
git init

# Add all files
git add .

# Commit
git commit -m "Initial backend setup"

# Create repo on GitHub, then:
git remote add origin https://github.com/your-username/auto-parts-backend.git
git branch -M main
git push -u origin main
```

---

### **Step 3: Deploy on Render.com**

#### 3.1 Sign Up
1. Go to [render.com](https://render.com)
2. Sign up with GitHub

#### 3.2 Create Web Service
1. Click **"New +"** ‚Üí **"Web Service"**
2. Connect your GitHub repository
3. Select `auto-parts-backend` repo

#### 3.3 Configure Service
```
Name: auto-parts-api
Environment: Node
Region: Frankfurt (closest to Africa)
Branch: main
Build Command: npm install
Start Command: npm start
```

#### 3.4 Select Free Plan
- Instance Type: **Free**
- Click **"Advanced"**

#### 3.5 Add Environment Variables
Click **"Add Environment Variable"** for each:

```
NODE_ENV=production
PORT=10000
MONGODB_URI=mongodb+srv://username:password@cluster0.xxxxx.mongodb.net/auto_parts_app
ALLOWED_ORIGINS=https://your-frontend.vercel.app,https://your-pwa.netlify.app
```

‚ö†Ô∏è **IMPORTANT**: Get your MongoDB URI from MongoDB Atlas

#### 3.6 Deploy
1. Click **"Create Web Service"**
2. Wait 5-10 minutes for first deploy
3. You'll get a URL like: `https://auto-parts-api.onrender.com`

---

### **Step 4: Upload Images to Render**

#### Option A: Include in Git (Small amounts)
```bash
# If images are < 500MB total
git add public/images/pieces/
git commit -m "Add product images"
git push
```

#### Option B: Use Cloud Storage (Recommended for many images)

**Use Cloudinary (Free tier: 25GB)**

1. Sign up at [cloudinary.com](https://cloudinary.com)
2. Get API credentials
3. Install: `npm install cloudinary multer`
4. Update your backend:

```javascript
// config/cloudinary.js
const cloudinary = require('cloudinary').v2;

cloudinary.config({
  cloud_name: process.env.CLOUDINARY_CLOUD_NAME,
  api_key: process.env.CLOUDINARY_API_KEY,
  api_secret: process.env.CLOUDINARY_API_SECRET
});

module.exports = cloudinary;
```

5. Bulk upload script:
```javascript
// uploadImages.js
const cloudinary = require('./config/cloudinary');
const fs = require('fs');
const path = require('path');

async function uploadAllImages() {
  const imagesDir = path.join(__dirname, 'public/images/pieces');
  const files = fs.readdirSync(imagesDir);
  
  for (const file of files) {
    const filePath = path.join(imagesDir, file);
    try {
      const result = await cloudinary.uploader.upload(filePath, {
        folder: 'auto-parts',
        public_id: file.split('.')[0]
      });
      console.log(`‚úÖ Uploaded: ${file}`);
    } catch (error) {
      console.error(`‚ùå Failed: ${file}`, error.message);
    }
  }
}

uploadAllImages();
```

6. Update image URLs in responses:
```javascript
// In your pieces route
const imageUrl = product.image_filename 
  ? `https://res.cloudinary.com/YOUR_CLOUD_NAME/image/upload/v1/auto-parts/${product.image_filename}`
  : null;
```

---

## üîß MongoDB Atlas Configuration

### Whitelist Render IP
1. Go to MongoDB Atlas dashboard
2. **Network Access** ‚Üí **Add IP Address**
3. Click **"Allow Access from Anywhere"** (0.0.0.0/0)
   - ‚ö†Ô∏è Or add Render's specific IPs if available

---

## ‚úÖ Test Your Deployed Backend

### Test endpoints:
```bash
# Health check
curl https://auto-parts-api.onrender.com/health

# Get products
curl https://auto-parts-api.onrender.com/api/pieces

# Get image (if using Render storage)
https://auto-parts-api.onrender.com/images/pieces/DZ1560160014.jpg
```

---

## üì± Update Frontend to Use Production API

### In your React app `.env`:
```env
# Development
VITE_API_BASE_URL=http://localhost:5000

# Production (update after deploy)
VITE_API_BASE_URL=https://auto-parts-api.onrender.com
VITE_IMAGES_BASE_URL=https://auto-parts-api.onrender.com/images/pieces
```

### Or use Cloudinary images:
```env
VITE_IMAGES_BASE_URL=https://res.cloudinary.com/YOUR_CLOUD_NAME/image/upload/v1/auto-parts
```

---

## üö® Important Production Checklist

- ‚úÖ **Environment variables set** (MongoDB URI, ALLOWED_ORIGINS)
- ‚úÖ **CORS configured** for your frontend domain
- ‚úÖ **MongoDB Atlas** allows connections from anywhere (0.0.0.0/0)
- ‚úÖ **Images uploaded** (via Git or Cloudinary)
- ‚úÖ **Health check** endpoint working
- ‚úÖ **HTTPS enabled** (automatic on Render)
- ‚úÖ **Error handling** in place
- ‚úÖ **Rate limiting** (optional but recommended)

---

## üí∞ Cost Breakdown

### Free Option:
- **Render**: Free (spins down after 15min inactivity)
- **MongoDB Atlas**: Free (512MB storage)
- **Cloudinary**: Free (25GB bandwidth/month)
- **Total**: $0/month ‚úÖ

### Paid Option (Better performance):
- **Render**: $7/month (always on)
- **MongoDB Atlas**: Free or $9/month (for more storage)
- **Cloudinary**: Free
- **Total**: $7-16/month

---

## üîÑ Auto-Deploy Updates

After initial setup, any push to GitHub automatically deploys:

```bash
# Make changes
git add .
git commit -m "Update API"
git push

# Render automatically deploys in ~5 minutes
```

---

## üêõ Troubleshooting

### Issue: "Cannot connect to MongoDB"
**Solution**: Check MongoDB Atlas Network Access, whitelist 0.0.0.0/0

### Issue: "CORS error"
**Solution**: Add frontend domain to ALLOWED_ORIGINS in Render environment variables

### Issue: "Images not loading"
**Solution**: 
- Check images are in `public/images/pieces/` folder
- Or verify Cloudinary URLs are correct

### Issue: "App spins down (Free tier)"
**Solution**: 
- Use a service like [UptimeRobot](https://uptimerobot.com) to ping your API every 5 minutes
- Or upgrade to paid plan ($7/month)

---

## üéâ You're Live!

Your backend is now:
- ‚úÖ Accessible online
- ‚úÖ Connected to MongoDB Atlas
- ‚úÖ Serving images
- ‚úÖ Ready for your PWA frontend

**Your API URL**: `https://auto-parts-api.onrender.com`

**Next**: Deploy your React PWA frontend (Vercel/Netlify) and connect it! üöÄ